import Head from "next/head";
import { useQuery } from "urql";
import { PRODUCT_QUERY } from "../lib/query";
import Product from "../components/Product/Product";
import { GalleryStyled } from "../styles/Gallery";
import { useStateContext } from "../lib/context";
import { PaginationContainer } from "../styles/Pagination";

import { Pagination, CircularProgress } from "@mui/material";
import Sort from "../components/Sort/Sort";

export default function Home() {
    const {
        searchTag,
        setSearchTag,
        searchTitle,
        setSearchTitle,
        searchMinPrice,
        setSearchMinPrice,
        searchMaxPrice,
        setSearchMaxPrice,
        sortAlph,
        setSortAlph,
        tags,
        setTags,
        page,
        setPage,
        pagesOffset,
        setPagesOffset,
        pagesSize,
        pagesCount,
        setPagesCount,
    } = useStateContext();

    //fetch products from strapi
    const [results] = useQuery({
        query: PRODUCT_QUERY,
        variables: {
            PageLimit: pagesSize,
            PageOffset: pagesOffset,
            Name: searchTitle,
            MinPrice: searchMinPrice,
            MaxPrice: searchMaxPrice,
            Sort: sortAlph,
            Tag: searchTag,
        },
    });
    const { data, fetching, error } = results;

    const _changePage = (e, value) => {
        e.preventDefault();
        setPage(value);
        setPagesOffset(pagesSize * (value - 1));
    };

    //check for the data coming in
    if (fetching) return <CircularProgress />;
    if (error) return <p>Oh no... {error.message}</p>;
    const products = data.products.data;

    // const products = null;

    const { pageCount, pageSize, total } = data.products.meta.pagination;
    setTags(data.tags.data);
    setPagesCount(pageCount);

    const _handleChange = (e, variation) => {
        switch (variation) {
            case "alph":
                setSortAlph(e.target.value);
                console.log(e.target.value);
                break;
            case "tag":
                setSearchTag(e.target.value);
                console.log(e.target.value);
                break;
            case "name":
                setSearchTitle(e.target.value);
                console.log(e.target.value);
                break;
            case "minPrice":
                setSearchMinPrice(e.target.value);
                console.log(e.target.value);
                break;
            case "maxPrice":
                setSearchMaxPrice(e.target.value);
                console.log(e.target.value);
                break;

            default:
                break;
        }
    };

    return (
        <>
            <Head>
                <title>Styled</title>
                <meta name="description" content="Generated by create next app" />
                <link rel="icon" href="/favicon.ico" />
                <link rel="preconnect" href="https://fonts.googleapis.com" />
                <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
                <link href="https://fonts.googleapis.com/css2?family=Montserrat&display=swap" rel="stylesheet"></link>
            </Head>

            <main>
                <div>
                    <Sort />
                    {/* <Selectors>
                        <SelectorsInner>
                            <Input placeholder="Name" sx={{ width: 220 }} value={searchTitle} onChange={(e) => _handleChange(e, "name")} />

                            <FormControl sx={{ minWidth: 180 }} size="small">
                                <InputLabel>Alphabetically</InputLabel>
                                <Select label="Alphabetically" onChange={(e) => _handleChange(e, "alph")} value={sortAlph}>
                                    <MenuItem value={`desc`}>A-Z</MenuItem>
                                    <MenuItem value={`asc`}>Z-A</MenuItem>
                                </Select>
                            </FormControl>

                            <FormControl sx={{ minWidth: 180 }} size="small">
                                <InputLabel>Tag</InputLabel>
                                <Select label="Tag" onChange={(e) => _handleChange(e, "tag")} value={searchTag}>
                                    {tags && tags.map((tag) => <MenuItem value={tag.attributes.tag}>{tag.attributes.tag}</MenuItem>)}
                                </Select>
                            </FormControl>

                            <div id="priceSelectors">
                                <h3>Price</h3>
                                <Input placeholder="Min Price" sx={{ maxWidth: 120 }} value={searchMinPrice} onChange={(e) => _handleChange(e, "minPrice")} />
                                <Input placeholder="Max Price" sx={{ maxWidth: 120 }} value={searchMinPrice} onChange={(e) => _handleChange(e, "maxPrice")} />
                            </div>
                        </SelectorsInner>
                    </Selectors> */}

                    <GalleryStyled>{products && products.map((product) => <Product product={product.attributes} key={product.attributes.slug} />)}</GalleryStyled>
                </div>

                <PaginationContainer>
                    <Pagination count={pagesCount} page={page} shape={"rounded"} onChange={_changePage} />
                </PaginationContainer>
            </main>
        </>
    );
}
